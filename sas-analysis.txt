/* Create the dataset */
data cash_study;
   input school $ amount @@;
   datalines;
SMU 34 SMU 200 SMU 23 SMU 50 SMU 60 SMU 50 SMU 0 SMU 0 
SMU 30 SMU 89 SMU 0 SMU 300 SMU 400 SMU 20 SMU 10 SMU 0
Seattle 20 Seattle 10 Seattle 5 Seattle 0 Seattle 30 Seattle 50 
Seattle 0 Seattle 100 Seattle 110 Seattle 0 Seattle 40 Seattle 10 
Seattle 3 Seattle 0
;
run;

/* Create histograms for visual comparison */
proc sgpanel data=cash_study;
   panelby school / columns=2;
   histogram amount;
   title "Distribution of Cash Amounts by School";
run;

/* Get basic summary statistics */
proc means data=cash_study mean std n maxdec=2;
   class school;
   var amount;
   title "Summary Statistics of Cash Amounts by School";
run;

/* Regular t-test for comparison with permutation test */
proc ttest data=cash_study;
   class school;
   var amount;
   title "Two-Sample T-Test Results";
run;

/* Permutation test using PROC IML */
proc iml;
   /* Read the data */
   use cash_study;
   read all var {school amount} into x;
   close cash_study;
   
   /* Get observed difference in means */
   smu = x[loc(x[,1]="SMU"), 2];
   seattle = x[loc(x[,1]="Seattle"), 2];
   obs_diff = mean(smu) - mean(seattle);
   
   /* Set up permutation test */
   n_perm = 10000;
   all_data = x[,2];
   n1 = nrow(smu);
   n = nrow(x);
   diff_holder = j(n_perm, 1, .);
   
   /* Run permutations */
   do i = 1 to n_perm;
      /* Randomly permute the data */
      perm_data = sample(all_data, n, "WOR");
      g1 = perm_data[1:n1];
      g2 = perm_data[(n1+1):n];
      
      /* Calculate and store difference in means */
      diff_holder[i] = mean(g1) - mean(g2);
   end;
   
   /* Calculate two-sided p-value */
   p_value = sum(abs(diff_holder) >= abs(obs_diff)) / n_perm;
   
   /* Print results */
   print "Observed Difference in Means" obs_diff;
   print "P-value from Permutation Test" p_value;
   
   /* Create histogram of permuted differences */
   title "Distribution of Permuted Differences in Means";
   call histogram(diff_holder) grid="true";
   refline = "refline " + char(obs_diff) + " / axis=x lineattrs=(color=red);";
   call Histogram(diff_holder) other=refline;
quit;
